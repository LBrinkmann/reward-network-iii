#

stages:
  - build
  - docker
  - deploy
  - undeploy

variables:
  APP_NAME: react-app-template
  DOCKER_HOST: tcp://localhost:2375/
  DOCKER_DRIVER: overlay2
  REGISTERY_URL: docker.gitlab.gwdg.de
  DOCKER_REGISTERY_PREFIX: mpib/chm/common/base-images
  IMAGE_NAME: ${APP_NAME}
  IMAGE_TAG: ${CI_COMMIT_TIMESTAMP}_${CI_COMMIT_SHORT_SHA}

.tags: &tags
  tags:
    - chm

.before: &before
  before_script:
    - docker login --username ${REGISTERY_USERNAME} --password ${REGISTERY_PASSWORD} ${REGISTERY_URL}
.services: &services
  services:
    - name: "docker:18.09.0-dind"
      alias: docker

.deploy: &deploy
  script:
    - aws --region eu-central-1 eks update-kubeconfig --name chm-test-default --region eu-central-1
    - helm upgrade -n mcu --install ${APP_NAME}-${CI_COMMIT_REF_NAME} charts/react-app-template
      --set dockersecret=${DOCKERCFG},image.tag=${IMAGE_TAG}
      --set branchName=${CI_COMMIT_REF_NAME}
      --set app.name=${APP_NAME}
      --atomic

.commonheader: &commonheader
  <<: *services
  <<: *tags
  <<: *before

cache:
  paths:
    - node_modules/

build:
  <<: *commonheader
  before_script:
    - echo "Overriding before_script"
  stage: build
  image: node:12
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  script:
    - npm ci
    - npm run build-prod

buildimage:
  <<: *commonheader
  stage: docker
  image: docker:18.09.0
  script:
    - docker build --no-cache -f Dockerfile -t ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/${IMAGE_NAME}:${IMAGE_TAG} -t ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/${IMAGE_NAME}:latest .
    - docker push ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/${IMAGE_NAME}:${IMAGE_TAG}
    - docker push ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/${IMAGE_NAME}:latest

deploy-prod:
  <<: *commonheader
  only:
    refs:
      - master
  stage: deploy
  image: ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/app/cd-tools:0.1
  environment: Production
  <<: *deploy

deploy-nonprod:
  <<: *commonheader
  except:
    refs:
      - master
  stage: deploy
  image: ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/app/cd-tools:0.1
  <<: *deploy

undeploy-nonprod:
  <<: *commonheader
  except:
    refs:
      - master
  stage: undeploy
  image: ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/app/cd-tools:0.1
  when: manual
  script:
    - aws --region eu-central-1 eks update-kubeconfig --name chm-test-default --region eu-central-1
    - helm uninstall ${APP_NAME}-${CI_COMMIT_REF_NAME}
