include:
  - local: 'app.yml'

stages:
  - init
  - build
  - docker
  - deploy
  - undeploy

variables:
  DOCKER_HOST: tcp://localhost:2375/
  DOCKER_DRIVER: overlay2
  REGISTERY_URL: docker.gitlab.gwdg.de
  DOCKER_REGISTERY_PREFIX: mpib/chm/common/base-images
  IMAGE_NAME: ${APP_NAME}

.tags: &tags
  tags:
    - chm

.before: &before
  before_script:
    - export COMMIT_TIMESTAMP=$(cat COMMIT_TIMESTAMP)
    - export IMAGE_TAG=${COMMIT_TIMESTAMP}_${CI_COMMIT_SHORT_SHA}
    - docker login --username ${REGISTERY_USERNAME} --password ${REGISTERY_PASSWORD} ${REGISTERY_URL}
.services: &services
  services:
    - name: "docker:18.09.0-dind"
      alias: docker

.deploy: &deploy
  script:
    - aws --region eu-central-1 eks update-kubeconfig --name chm-test-default --region eu-central-1
    - helm upgrade -n mcu --install ${APP_NAME}-${CI_COMMIT_REF_NAME}
      charts/static-web-server
      --set dockersecret=${DOCKERCFG}
      --set image.name=${IMAGE_NAME}
      --set image.tag=${IMAGE_TAG}
      --set branchName=${CI_COMMIT_REF_NAME}
      --set app.name=${APP_NAME}
      --set nameOverride=${APP_NAME}
      --set app.main_url=${MAIN_URL}
      --atomic

.commonheader: &commonheader
  <<: *services
  <<: *tags
  <<: *before

cache:
  paths:
    - node_modules/

init:
  stage: init
  <<: *services
  <<: *tags
  script:
    - apk add --no-cache git
    - git log --pretty='format:%C(auto)%ad' --date=format:%Y%m%d-%H%M%S -n 1 > COMMIT_TIMESTAMP
  artifacts:
    paths:
      - COMMIT_TIMESTAMP
    expire_in: 1 day

build:
  <<: *commonheader
  before_script:
    - echo "Overriding before_script"
  stage: build
  image: node:12
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  script:
    - npm ci
    - npm run build-prod

buildimage:
  <<: *commonheader
  stage: docker
  image: docker:18.09.0
  script:
    - echo "${IMAGE_TAG}"
    - docker build --no-cache -f Dockerfile -t ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/${IMAGE_NAME}:${IMAGE_TAG} -t ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/${IMAGE_NAME}:latest .
    - docker push ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/${IMAGE_NAME}:${IMAGE_TAG}
    - docker push ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/${IMAGE_NAME}:latest

deploy-prod:
  <<: *commonheader
  only:
    refs:
      - master
  stage: deploy
  image: ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/app/cd-tools:0.1
  environment: Production
  <<: *deploy

deploy-dev:
  <<: *commonheader
  only:
    refs:
      - dev
  stage: deploy
  image: ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/app/cd-tools:0.1
  <<: *deploy

undeploy-dev:
  <<: *commonheader
  only:
    refs:
      - dev
  stage: undeploy
  image: ${REGISTERY_URL}/${DOCKER_REGISTERY_PREFIX}/app/cd-tools:0.1
  when: manual
  script:
    - aws --region eu-central-1 eks update-kubeconfig --name chm-test-default --region eu-central-1
    - helm -n mcu uninstall ${APP_NAME}-${CI_COMMIT_REF_NAME}
