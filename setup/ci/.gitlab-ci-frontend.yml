variables:
  APP_NAME: rn-iii-frontend
  BACKEND_URL: https://rn-iii-backend.eks-test-default.mpg-chm.com
  DOCKER_FILE: setup/docker/Dockerfile-frontend
  MAIN_URL: rn-iii-frontend.eks-test-default.mpg-chm.com
  FRONTEND_PATH: frontend

include:
  - project: "mpib/chm/common/deploy-pipeline"
    ref: "1.8.2"
    file: "react-app.yml"

init:
  extends: .init-stage

  script:
    - apk add --no-cache git
    - source deploy-pipeline/build_env.sh
    - /bin/sh deploy-pipeline/display_env.sh # BUG: /bin/bash not available in image

build:
  before_script:
    - cd $FRONTEND_PATH # Feature: make frontend path configurable
  cache:
    paths:
      - ${FRONTEND_PATH}/node_modules/ # Feature: make frontend path configurable

  artifacts:
    paths:
      - ${FRONTEND_PATH}/dist/ # Feature: make frontend path configurable
    expire_in: 1 week

docker:
  extends: .docker-stage
  script:
    - /bin/sh deploy-pipeline/docker_login.sh # BUG: /bin/bash not available in image
    - echo "${IMAGE_NAME}:${IMAGE_TAG}"
    - DOCKER_TARGET_ARG=$( [ -z "$DOCKER_TARGET" ] && echo "" || echo "--target ${DOCKER_TARGET}" )
    - /kaniko/executor
      --context "$CI_PROJECT_DIR"
      --dockerfile "${DOCKER_FILE}"
      ${DOCKER_TARGET_ARG}
      --destination
      "${REGISTRY_URL}/${DOCKER_REGISTRY_PREFIX}/${IMAGE_NAME}:${IMAGE_TAG}"
